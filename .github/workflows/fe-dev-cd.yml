name: Deploy React App to Dev S3

on:
  push:
    branches: [dev]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{secrets.AWS_REGION}}     # AWS CLI ê¸°ë³¸ ë¦¬ì „

    steps:
    # 1) ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2) Node.js ì„¤ì¹˜
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '23.11.0'      # í”„ë¡œì íŠ¸ ë²„ì „ì— ë§ì¶° ë³€ê²½

    # 3) Infisical CLIë¡œ .env ìƒì„±
    - name: Fetch environment variables from Infisical
      env:
        INFISICAL_ENV:           ${{ secrets.INFISICAL_ENV_DEV }}
        INFISICAL_PROJECT_ID:    ${{ secrets.INFISICAL_PROJECT_ID }}
        INFISICAL_TOKEN:         ${{ secrets.INFISICAL_TOKEN_DEV }}
        INFISICAL_API_URL:       ${{ secrets.INFISICAL_API_URL }}
        INFISICAL_CLOUDFRONT:    ${{ secrets.AWS_CLOUDFRONT_URL }}
      run: |
        echo "â¬‡ï¸ Downloading Infisical CLI..."
        curl -Ls https://${INFISICAL_CLOUDFRONT}/tools/infisical-linux-amd64 -o infisical
        chmod +x infisical
        echo "ğŸ” Exporting secrets to .env..."
        ./infisical export \
          --env=$INFISICAL_ENV \
          --projectId=$INFISICAL_PROJECT_ID \
          --token=$INFISICAL_TOKEN \
          --format=dotenv \
          --domain=$INFISICAL_API_URL > .env

    # 4) ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Dependencies
      run: npm ci                # npm install ëŒ€ì‹  ci ì‚¬ìš© ê¶Œì¥

    # 5) ë¹Œë“œ (env ë¡œë“œ ì™„ë£Œ ìƒíƒœ)
    - name: Build React App
      run: npm run build         # ë¹Œë“œ ê²°ê³¼ë¬¼ì€ dist/ ì— ìƒì„±ëœë‹¤ê³  ê°€ì •

    # 6) AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID_S3_FE }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_S3_FE }}
        aws-region:            ${{ env.AWS_REGION }}

    # 7) S3 ë™ê¸°í™” (dist/ ë‚´ë¶€ë§Œ)
    - name: Sync to S3
      run: aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET_NAME_DEV }} --delete

    # 8) CloudFront ìºì‹œ ë¬´íš¨í™”
    - name: Invalidate CloudFront Cache
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_FE_DEV }} \
          --paths "/*"
